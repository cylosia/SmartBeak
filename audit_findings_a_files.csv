File,Line,Category,Issue,Evidence,Recommendation,StatusCode,Retryability,CrossFilePattern
packages/security/audit.ts,167,TypeScript,Missing null check on event parameter properties,"async log(event: Omit<AuditEvent, 'id' | 'timestamp' | 'hash' | 'previousHash'>): Promise<void>","Add runtime validation to ensure event.actor, event.resource, and event.action are not undefined/null before usage",,,type-assertion
packages/security/audit.ts,173,Security,generateEventId() uses predictable timestamp prefix,"id: this.generateEventId()","Use crypto.randomUUID() instead of timestamp-based IDs to prevent temporal correlation attacks",,,security-timing
packages/security/audit.ts,195,TypeScript,Bracket notation access on logger without type guard,"this.logger[""error""]('Too many audit flush failures'...)","Use proper logger.error() method without bracket notation",,,type-assertion
packages/security/audit.ts,214,TypeScript,Explicit any type in function parameter,"details?: Record<string, any>","Replace 'any' with 'unknown' and add type guard for safe access",,,type-assertion
packages/security/audit.ts,221,TypeScript,Non-null assertion with array access without bounds checking,"action: type.split('.')[1] as string","Add bounds check: if (parts[1]) action = parts[1]; else throw error",,,type-assertion
packages/security/audit.ts,287,Async,flush() doesn't handle concurrent calls - race condition,"private async flush(): Promise<void>","Add mutex lock or flag to prevent concurrent flush operations",,,race-condition
packages/security/audit.ts,290,Database,Buffer splice creates race condition with concurrent log(),"const events = this.buffer.splice(0, this.buffer.length)","Use a mutex/lock to protect buffer access",,,race-condition
packages/security/audit.ts,316,TypeScript,Bracket notation access without type guard,"events.map((e) => e.actor[""ip""] || '')","Use optional chaining: events.map((e) => e.actor.ip ?? '')",,,type-assertion
packages/security/audit.ts,323-324,Security,JSON.stringify on untrusted data could cause DoS,"JSON.stringify(e.details), JSON.stringify(e.changes || {})","Use safe-json-stringify library or add size limits before stringifying",,,security-dos
packages/security/audit.ts,419,TypeScript,parseInt without radix parameter,"parseInt(countResult.rows[0].total)","Use parseInt(countResult.rows[0].total, 10)",500,Retryable,type-assertion
packages/security/audit.ts,419,TypeScript,Array access without bounds checking,"countResult.rows[0].total","Add check: if (!countResult.rows[0]) throw new Error()",500,Retryable,array-access-safety
packages/security/audit.ts,539,Security,previousHash comparison without constant-time comparison,"if (event.previousHash !== previousHash)","Use crypto.timingSafeEqual for comparing hashes",,,security-timing
packages/security/audit.ts,548,Security,Hash comparison without constant-time comparison,"if (calculatedHash !== event.hash)","Use crypto.timingSafeEqual for comparing hashes",,,security-timing
packages/security/audit.ts,575,Security,Event ID generation uses Date.now() which is not cryptographically random,"return `evt_${Date.now()}_${crypto.randomBytes(8).toString('hex')}`","Use crypto.randomUUID() for truly random, unpredictable IDs",,,security-timing
packages/security/audit.ts,90,Async,lastHash is not thread-safe - concurrent log() calls can corrupt hash chain,"private lastHash: string = ''","Use mutex/lock when updating lastHash or use atomic operations",,,race-condition
packages/security/audit.ts,140-142,Async,setInterval without error handling,"this.flushTimer = setInterval(() => { this.flush(); }, ...)","Wrap flush() in try-catch: setInterval(() => { this.flush().catch(e => logger.error()) }, ...)",,,error-handling
packages/kernel/auth.ts,105,Security,Stub implementation throws error - not suitable for production,"throw new TokenInvalidError('Token verification not implemented...')","Remove this stub entirely or make it clear this is a test-only module",401,Non-retryable,architecture
packages/kernel/auth.ts,105,TypeScript,Function parameter _options is prefixed with underscore but never used,"export function verifyToken(token: string, _options: VerifyTokenOptions = {}): unknown","Remove unused parameter or document why it's needed for interface compatibility",,,architecture
packages/kernel/auth.ts,105,Security,Return type is 'unknown' which provides no type safety,"export function verifyToken(...): unknown","Define proper return type matching expected JWT claims structure",,,type-assertion
apps/api/src/routes/email/auth.ts,29-30,Security,Missing null checks on claims properties - authZ bypass possible,"if (!claims.sub || !claims.orgId) { return null; }","Add explicit checks: if (!claims.sub || typeof claims.sub !== 'string' || claims.sub.trim() === '') return null",401,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,33,Security,AuthContext returned without validating UUID format,"return { userId: claims.sub, orgId: claims.orgId }","Validate UUID format: if (!isValidUUID(claims.sub) || !isValidUUID(claims.orgId)) return null",401,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,50-56,Database,JOIN query doesn't verify org_id consistency,".join('memberships', 'memberships.org_id', 'domain_registry.org_id')","Add WHERE clause to verify orgId parameter matches both tables",403,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,50-56,Security,AuthZ check doesn't validate user's role,".select('memberships.role').first()","Add role validation: .whereIn('memberships.role', ['owner', 'admin', 'editor'])",403,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,63,ErrorHandling,Returns false on database error - indistinguishable from legitimate denial,"return false","Throw error or return Result type: { allowed: boolean, error?: Error }",500,Retryable,error-handling
apps/api/src/routes/emailSubscribers/auth.ts,24-29,ErrorHandling,requireAuth throws generic Error instead of proper AuthError,"throw new Error('Unauthorized')","Use AuthError or TokenInvalidError from @security/jwt",401,Non-retryable,error-handling
apps/api/src/routes/emailSubscribers/auth.ts,44-45,Security,Missing null checks on claims properties,"if (!claims.sub || !claims.orgId) { return null; }","Add explicit checks: if (!claims.sub || typeof claims.sub !== 'string' || claims.sub.trim() === '') return null",401,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,48,Security,AuthContext returned without validating UUID format,"return { userId: claims.sub, orgId: claims.orgId }","Validate UUID format: if (!isValidUUID(claims.sub) || !isValidUUID(claims.orgId)) return null",401,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,65-71,Security,AuthZ check doesn't validate user's role,".select('memberships.role').first()","Add role validation: .whereIn('memberships.role', ['owner', 'admin', 'editor'])",403,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,78,ErrorHandling,Returns false on database error,"return false","Throw error or return Result type",500,Retryable,error-handling
apps/api/src/routes/adminAudit.ts,6,TypeScript,Missing import for getLogger,"const logger = getLogger('adminAudit')","Add import: import { getLogger } from '@kernel/logger'",,,
apps/api/src/routes/adminAudit.ts,16-23,Security,verifyAdminOrgAccess accepts userId but adminBilling version does not,"async function verifyAdminOrgAccess(userId: string, orgId: string)","This implementation is SECURE. adminBilling.ts needs to match this pattern",,,duplicate
apps/api/src/routes/adminAudit.ts,110-150,Security,No rate limiting middleware applied,"app.addHook('onRequest', async (req, reply) => {","Add adminRateLimit() hook before auth hook",,,
apps/api/src/routes/adminAudit.ts,273-275,Security,Sensitive data exposure in development mode,"errorResponse[""message""] = error[""message""]","Use sanitizeErrorMessage from @security/logger",500,,
apps/api/src/routes/adminAuditExport.ts,155-160,Security,Uses custom regex for UUID validation instead of isValidUUID,"if (!/^[0-9a-f]{8}-...$/i.test(adminId))","Replace with isValidUUID(adminId) for consistency",400,Non-retryable,
apps/api/src/routes/adminAuditExport.ts,70-76,Security,verifyOrgMembership doesn't verify role is admin/owner,".where({ user_id: adminId, org_id: orgId }).first()","Add role verification: .whereIn('role', ['admin', 'owner'])",,,security-authz
apps/api/src/routes/adminAuditExport.ts,9,Security,Export limit max of 1000 rows could cause memory exhaustion,"limit: z.coerce.number().min(1).max(1000)","Reduce max to 500 for serverless safety",,,
apps/api/src/routes/adminAuditExport.ts,173-196,Performance,Entire CSV built in memory before sending,"const body = rows.map(...).join('\n')","For large exports, use streaming: implement Transform stream",,,
apps/api/src/routes/adminAuditExport.ts,99,ErrorHandling,Uses console.error instead of structured logger,"console.error('[admin-audit-export-hook] Error:', error)","Replace with logger.error()",,,
apps/api/src/routes/adminAuditExport.ts,203,ErrorHandling,Uses console.error instead of structured logger,"console.error('[admin-audit-export] Error:', error)","Replace with logger.error()",,,
apps/api/src/routes/adminBilling.ts,20-30,Security,CRITICAL IDOR VULNERABILITY - verifyAdminOrgAccess doesn't verify user,"async function verifyAdminOrgAccess(orgId: string)","CRITICAL FIX: Add userId parameter and verify: .where({ user_id: userId, org_id: orgId }).whereIn('role', ['admin', 'owner'])",403,Non-retryable,security-authz
apps/api/src/routes/adminBilling.ts,219,Security,CRITICAL - No x-admin-id header validation,"const hasAccess = await verifyAdminOrgAccess(orgId)","CRITICAL FIX: Extract and validate x-admin-id header, pass to verifyAdminOrgAccess",,,security-authz
apps/api/src/routes/adminBilling.ts,286,Security,CRITICAL - No x-admin-id header validation,"const hasAccess = await verifyAdminOrgAccess(id)","CRITICAL FIX: Extract and validate x-admin-id header, pass to verifyAdminOrgAccess",,,security-authz
apps/api/src/routes/adminBilling.ts,132,Database,getDb() called at route registration time not per-request,"const db = await getDb()","Move getDb() call inside request handlers",,,
apps/api/src/routes/adminBilling.ts,72-79,Security,AdminBillingQuerySchema doesn't use .strict() mode,"AdminBillingQuerySchema = z.object({...})","Add .strict() to reject unknown properties: z.object({...}).strict()",,,
apps/api/src/routes/adminBilling.ts,234-239,Database,Query filters by single org_id but uses pagination,".where({ id: orgId }).limit(limit).offset(offset)","Endpoint should return single org object, not paginated array",,,
