File,Line,Category,Issue,Evidence,Recommendation,StatusCode,Retryability,CrossFilePattern
packages/security/audit.ts,167,TypeScript,Missing null check on event parameter properties,"async log(event: Omit<AuditEvent, 'id' | 'timestamp' | 'hash' | 'previousHash'>): Promise<void>","Add runtime validation to ensure event.actor, event.resource, and event.action are not undefined/null before usage",,,type-assertion
packages/security/audit.ts,173,Security,generateEventId() uses predictable timestamp prefix,"id: this.generateEventId()","Use crypto.randomUUID() instead of timestamp-based IDs to prevent temporal correlation attacks",,,security-timing
packages/security/audit.ts,195,TypeScript,Bracket notation access on logger without type guard,"this.logger[""error""]('Too many audit flush failures'...)","Use proper logger.error() method without bracket notation",,,type-assertion
packages/security/audit.ts,214,TypeScript,Explicit any type in function parameter,"details?: Record<string, any>","Replace 'any' with 'unknown' and add type guard for safe access",,,type-assertion
packages/security/audit.ts,221,TypeScript,Non-null assertion with array access without bounds checking,"action: type.split('.')[1] as string","Add bounds check: if (parts[1]) action = parts[1]; else throw error",,,type-assertion
packages/security/audit.ts,287,Async,flush() doesn't handle concurrent calls - race condition,"private async flush(): Promise<void>","Add mutex lock or flag to prevent concurrent flush operations",,,race-condition
packages/security/audit.ts,290,Database,Buffer splice creates race condition with concurrent log(),"const events = this.buffer.splice(0, this.buffer.length)","Use a mutex/lock to protect buffer access",,,race-condition
packages/security/audit.ts,316,TypeScript,Bracket notation access without type guard,"events.map((e) => e.actor[""ip""] || '')","Use optional chaining: events.map((e) => e.actor.ip ?? '')",,,type-assertion
packages/security/audit.ts,323-324,Security,JSON.stringify on untrusted data could cause DoS,"JSON.stringify(e.details), JSON.stringify(e.changes || {})","Use safe-json-stringify library or add size limits before stringifying",,,security-dos
packages/security/audit.ts,419,TypeScript,parseInt without radix parameter,"parseInt(countResult.rows[0].total)","Use parseInt(countResult.rows[0].total, 10)",500,Retryable,type-assertion
packages/security/audit.ts,419,TypeScript,Array access without bounds checking,"countResult.rows[0].total","Add check: if (!countResult.rows[0]) throw new Error()",500,Retryable,array-access-safety
packages/security/audit.ts,539,Security,previousHash comparison without constant-time comparison,"if (event.previousHash !== previousHash)","Use crypto.timingSafeEqual for comparing hashes",,,security-timing
packages/security/audit.ts,548,Security,Hash comparison without constant-time comparison,"if (calculatedHash !== event.hash)","Use crypto.timingSafeEqual for comparing hashes",,,security-timing
packages/security/audit.ts,575,Security,Event ID generation uses Date.now() which is not cryptographically random,"return `evt_${Date.now()}_${crypto.randomBytes(8).toString('hex')}`","Use crypto.randomUUID() for truly random, unpredictable IDs",,,security-timing
packages/security/audit.ts,90,Async,lastHash is not thread-safe - concurrent log() calls can corrupt hash chain,"private lastHash: string = ''","Use mutex/lock when updating lastHash or use atomic operations",,,race-condition
packages/security/audit.ts,140-142,Async,setInterval without error handling,"this.flushTimer = setInterval(() => { this.flush(); }, ...)","Wrap flush() in try-catch: setInterval(() => { this.flush().catch(e => logger.error()) }, ...)",,,error-handling
packages/kernel/auth.ts,105,Security,Stub implementation throws error - not suitable for production,"throw new TokenInvalidError('Token verification not implemented...')","Remove this stub entirely or make it clear this is a test-only module",401,Non-retryable,architecture
packages/kernel/auth.ts,105,TypeScript,Function parameter _options is prefixed with underscore but never used,"export function verifyToken(token: string, _options: VerifyTokenOptions = {}): unknown","Remove unused parameter or document why it's needed for interface compatibility",,,architecture
packages/kernel/auth.ts,105,Security,Return type is 'unknown' which provides no type safety,"export function verifyToken(...): unknown","Define proper return type matching expected JWT claims structure",,,type-assertion
apps/api/src/routes/email/auth.ts,29-30,Security,Missing null checks on claims properties - authZ bypass possible,"if (!claims.sub || !claims.orgId) { return null; }","Add explicit checks: if (!claims.sub || typeof claims.sub !== 'string' || claims.sub.trim() === '') return null",401,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,33,Security,AuthContext returned without validating UUID format,"return { userId: claims.sub, orgId: claims.orgId }","Validate UUID format: if (!isValidUUID(claims.sub) || !isValidUUID(claims.orgId)) return null",401,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,50-56,Database,JOIN query doesn't verify org_id consistency,".join('memberships', 'memberships.org_id', 'domain_registry.org_id')","Add WHERE clause to verify orgId parameter matches both tables",403,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,50-56,Security,AuthZ check doesn't validate user's role,".select('memberships.role').first()","Add role validation: .whereIn('memberships.role', ['owner', 'admin', 'editor'])",403,Non-retryable,security-authz
apps/api/src/routes/email/auth.ts,63,ErrorHandling,Returns false on database error - indistinguishable from legitimate denial,"return false","Throw error or return Result type: { allowed: boolean, error?: Error }",500,Retryable,error-handling
apps/api/src/routes/emailSubscribers/auth.ts,24-29,ErrorHandling,requireAuth throws generic Error instead of proper AuthError,"throw new Error('Unauthorized')","Use AuthError or TokenInvalidError from @security/jwt",401,Non-retryable,error-handling
apps/api/src/routes/emailSubscribers/auth.ts,44-45,Security,Missing null checks on claims properties,"if (!claims.sub || !claims.orgId) { return null; }","Add explicit checks: if (!claims.sub || typeof claims.sub !== 'string' || claims.sub.trim() === '') return null",401,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,48,Security,AuthContext returned without validating UUID format,"return { userId: claims.sub, orgId: claims.orgId }","Validate UUID format: if (!isValidUUID(claims.sub) || !isValidUUID(claims.orgId)) return null",401,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,65-71,Security,AuthZ check doesn't validate user's role,".select('memberships.role').first()","Add role validation: .whereIn('memberships.role', ['owner', 'admin', 'editor'])",403,Non-retryable,security-authz
apps/api/src/routes/emailSubscribers/auth.ts,78,ErrorHandling,Returns false on database error,"return false","Throw error or return Result type",500,Retryable,error-handling
apps/api/src/routes/adminAudit.ts,6,TypeScript,Missing import for getLogger,"const logger = getLogger('adminAudit')","Add import: import { getLogger } from '@kernel/logger'",,,
apps/api/src/routes/adminAudit.ts,16-23,Security,verifyAdminOrgAccess accepts userId but adminBilling version does not,"async function verifyAdminOrgAccess(userId: string, orgId: string)","This implementation is SECURE. adminBilling.ts needs to match this pattern",,,duplicate
apps/api/src/routes/adminAudit.ts,110-150,Security,No rate limiting middleware applied,"app.addHook('onRequest', async (req, reply) => {","Add adminRateLimit() hook before auth hook",,,
apps/api/src/routes/adminAudit.ts,273-275,Security,Sensitive data exposure in development mode,"errorResponse[""message""] = error[""message""]","Use sanitizeErrorMessage from @security/logger",500,,
apps/api/src/routes/adminAuditExport.ts,155-160,Security,Uses custom regex for UUID validation instead of isValidUUID,"if (!/^[0-9a-f]{8}-...$/i.test(adminId))","Replace with isValidUUID(adminId) for consistency",400,Non-retryable,
apps/api/src/routes/adminAuditExport.ts,70-76,Security,verifyOrgMembership doesn't verify role is admin/owner,".where({ user_id: adminId, org_id: orgId }).first()","Add role verification: .whereIn('role', ['admin', 'owner'])",,,security-authz
apps/api/src/routes/adminAuditExport.ts,9,Security,Export limit max of 1000 rows could cause memory exhaustion,"limit: z.coerce.number().min(1).max(1000)","Reduce max to 500 for serverless safety",,,
apps/api/src/routes/adminAuditExport.ts,173-196,Performance,Entire CSV built in memory before sending,"const body = rows.map(...).join('\n')","For large exports, use streaming: implement Transform stream",,,
apps/api/src/routes/adminAuditExport.ts,99,ErrorHandling,Uses console.error instead of structured logger,"console.error('[admin-audit-export-hook] Error:', error)","Replace with logger.error()",,,
apps/api/src/routes/adminAuditExport.ts,203,ErrorHandling,Uses console.error instead of structured logger,"console.error('[admin-audit-export] Error:', error)","Replace with logger.error()",,,
apps/api/src/routes/adminBilling.ts,20-30,Security,CRITICAL IDOR VULNERABILITY - verifyAdminOrgAccess doesn't verify user,"async function verifyAdminOrgAccess(orgId: string)","CRITICAL FIX: Add userId parameter and verify: .where({ user_id: userId, org_id: orgId }).whereIn('role', ['admin', 'owner'])",403,Non-retryable,security-authz
apps/api/src/routes/adminBilling.ts,219,Security,CRITICAL - No x-admin-id header validation,"const hasAccess = await verifyAdminOrgAccess(orgId)","CRITICAL FIX: Extract and validate x-admin-id header, pass to verifyAdminOrgAccess",,,security-authz
apps/api/src/routes/adminBilling.ts,286,Security,CRITICAL - No x-admin-id header validation,"const hasAccess = await verifyAdminOrgAccess(id)","CRITICAL FIX: Extract and validate x-admin-id header, pass to verifyAdminOrgAccess",,,security-authz
apps/api/src/routes/adminBilling.ts,132,Database,getDb() called at route registration time not per-request,"const db = await getDb()","Move getDb() call inside request handlers",,,
apps/api/src/routes/adminBilling.ts,72-79,Security,AdminBillingQuerySchema doesn't use .strict() mode,"AdminBillingQuerySchema = z.object({...})","Add .strict() to reject unknown properties: z.object({...}).strict()",,,
apps/api/src/routes/adminBilling.ts,234-239,Database,Query filters by single org_id but uses pagination,".where({ id: orgId }).limit(limit).offset(offset)","Endpoint should return single org object, not paginated array",,,
control-plane/adapters/keywords/ahrefs.ts,40,Security,API token not validated - allows empty string bypass,"this.apiToken = apiToken || process.env['AHREFS_API_TOKEN'] || ''","Validate apiToken at lines 42-44 to reject empty string",,,
control-plane/adapters/keywords/ahrefs.ts,102-111,TypeScript,Unsafe type assertion on unknown JSON response,"const data = await res.json() as { keywords?: Array<{...}>}","Use type guard function or Zod schema validation",,,type-assertion
control-plane/adapters/keywords/ahrefs.ts,117-128,TypeScript,Array access without null/undefined checks on nested optional properties,"kw.keyword and kw.volume accessed without validation","Add type guard: if (!kw.keyword || typeof kw.volume !== 'number') { logger.warn(...); continue; }",,,
control-plane/adapters/keywords/ahrefs.ts,88-94,ErrorHandling,Rate limit error does not classify retryability explicitly,"if (response.status === 429) { throw error; }","Add explicit retryable: true property on error object",429,Retryable,
control-plane/adapters/keywords/ahrefs.ts,96,ErrorHandling,Non-429 errors not classified by retryability,"throw new Error(`Ahrefs API error: ${response.status}`)","Add status code to error and classify: 401/403/400 = non-retryable, 500/502/503/504 = retryable",,Unclassified,
control-plane/adapters/keywords/ahrefs.ts,241,ErrorHandling,Health check uses hardcoded endpoint /v3/hello that may not exist,"const res = await fetch(`${this.baseUrl}/v3/hello`)","Use documented health check endpoint or catch 404 errors",404,Non-retryable,
control-plane/adapters/keywords/ahrefs.ts,258,Security,Health check error message leaks raw error details,"error: healthy ? undefined : `Ahrefs API returned status ${res.status}`","Sanitize error messages: 'Service unavailable'",,,
control-plane/adapters/keywords/ahrefs_real.ts,24,Security,NotImplementedError could be caught and ignored,"throw new NotImplementedError('Ahrefs API integration not yet implemented')","Verify calling code has proper error handling",,Non-retryable,
apps/api/src/seo/ahrefsGap.ts,142-145,TypeScript,Type assertion in domain validation,"if (!domainRegex.test(domain as string))","Remove 'as string' cast - validateNonEmptyString already ensures type",,,type-assertion
apps/api/src/seo/ahrefsGap.ts,155-156,Security,API key length validation too permissive - 10 characters could be test key,"if ((apiKey as string).length < 10)","Increase minimum to 32 characters (typical API key length)",,,
apps/api/src/seo/ahrefsGap.ts,167-179,Security,POST body contains domain and competitors - potential request body logging exposure,"body: JSON.stringify({ domain, competitors })","Add comment: // SECURITY: Do not log request body - contains competitive intelligence",,,
apps/api/src/seo/ahrefsGap.ts,196-213,ErrorHandling,Comprehensive status code handling but missing 429 Retry-After header parsing,"case 429: throw new Error('Ahrefs API rate limit exceeded')","Extract and use Retry-After header like ahrefs.ts lines 89-93",429,Retryable,
apps/api/src/seo/ahrefsGap.ts,211,Security,Error message includes full errorBody which could contain sensitive data,"throw new Error(...`${errorBody || 'Unknown error'}`)","Truncate errorBody: ${errorBody?.substring(0, 200) || 'Unknown error'}",,,
apps/api/src/seo/ahrefsGap.ts,228-230,ErrorHandling,AbortError re-thrown but loses original error context,"if (error.name === 'AbortError') throw new Error('...')","Preserve original error as cause: throw new Error('...', { cause: error })",,Retryable,
apps/api/src/seo/ahrefsGap.ts,313,Database,Promise.all creates N concurrent database connections without pooling verification,"const keywords = await Promise.all(batchInputs.map(input => upsertKeyword(input)))","Verify upsertKeyword uses connection pooling - BATCH_SIZE=100 creates 100 concurrent queries",,,
apps/api/src/seo/ahrefsGap.ts,315-324,TypeScript,Array access with non-null assertion on batch array,"const phrase = batch[index]!","Remove ! and add guard: if (!phrase) { logger.error('Index mismatch'); continue; }",,,type-assertion
apps/web/lib/api-client.ts,84-86,ErrorHandling,4xx errors don't retry but function returns response,"if (response.status >= 400 && response.status < 500) return response","Document caller must check response.ok or throw immediately: if (!response.ok && response.status < 500) throw new Error(...)",400-499,Non-retryable,
apps/web/lib/api-client.ts,94,ErrorHandling,5xx errors throw generic error but should classify retryability,"throw new Error(`HTTP ${response.status}: ${response.statusText}`)","Add retryable flag: const err = new Error(...); (err as any).retryable = true; throw err",500-599,Retryable,
apps/web/lib/api-client.ts,104-106,ErrorHandling,AbortError doesn't distinguish timeout abort vs user-initiated,"if (lastError.name === 'AbortError') throw lastError","Add signal.aborted check: if (lastError.name === 'AbortError' || options.signal?.aborted) throw",,Non-retryable,
apps/web/lib/api-client.ts,109,Performance,Exponential backoff uses Math.random() for jitter - could create unbounded delays,"const delay = retryDelayMs * Math.pow(2, attempt) + Math.random() * 1000","Add max delay cap: Math.min(..., 30000)",,,
apps/web/lib/api-client.ts,163,Async,Signal not checked for already-aborted before starting request,"...(requestConfig.signal ? { signal: requestConfig.signal } : {})","Check signal.aborted before fetchWithRetry: if (requestConfig.signal?.aborted) throw new Error('Request aborted')",,Non-retryable,
apps/web/lib/api-client.ts,172-174,TypeScript,Text response type assertion to generic T without runtime validation,"return text as T","Add runtime check or throw error for type mismatch",,,type-assertion
apps/web/lib/api-client.ts,177-185,TypeScript,JSON response cast to generic T without schema validation,"return result as T","Add Zod schema validation or type guard",,,type-assertion
apps/web/lib/api-client.ts,230-232,Security,SSR cookie forwarding doesn't validate/sanitize cookie content,"ssrHeaders['Cookie'] = options.ctx.req.headers.cookie","Add cookie validation to prevent header injection: if (cookie && /^[a-zA-Z0-9=;, _-]+$/.test(cookie))",,,
control-plane/api/routes/affiliates.ts,17,Database,_pool parameter unused - placeholder data returned,"export async function affiliateRoutes(app: FastifyInstance, _pool: Pool)","Document: // TODO: Replace placeholder data with actual affiliate API integration",,,
control-plane/api/routes/affiliates.ts,39-58,Security,Hardcoded affiliate offer data could be stale or manipulated,"const allOffers = [...]","Replace with database query or external API call. Add TODO: // SECURITY: Replace hardcoded data",,,placeholder-data
control-plane/api/routes/affiliates.ts,79,Security,console.error logs error object with potential sensitive affiliate data,"console[""error""]('[affiliates/offers] Error:', error)","Sanitize error: console.error('[affiliates/offers] Error:', error instanceof Error ? error.message : 'Unknown error')",,,
control-plane/api/routes/analytics.ts,38,Database,Bracket notation d[id] and c[id] suggests reserved words,"'SELECT 1 FROM content c JOIN domains d ON c.domain_id = d[""id""]'","Use dot notation: d.id and c.id unless 'id' is reserved (it's not in Postgres)",,,
control-plane/api/routes/analytics.ts,45,Database,rm.getContentStats() called without try-catch,"return rm.getContentStats(id)","Wrap in try-catch to prevent database error leakage",500,Retryable,
control-plane/api/routes/attribution.ts,19-37,Security,CRITICAL - Hardcoded LLM attribution data could misrepresent AI usage to buyers,"const report = { citations: [...], cost: 125.5 }","CRITICAL: Replace with actual LLM usage tracking - misrepresentation violates platform policies",,,placeholder-data
control-plane/api/routes/attribution.ts,56-62,Security,CRITICAL - Buyer-safe attribution returns hardcoded values,"const summary = { aiAssisted: true, aiPercentage: 40 }","CRITICAL: Must reflect actual content metrics per FTC guidelines",,,placeholder-data
control-plane/api/routes/attribution.ts,41,Security,console.error logs error without sanitization,"console[""error""]('[attribution/llm] Error:', error)","Sanitize error logging",,,
control-plane/api/routes/attribution.ts,66,Security,console.error logs error without sanitization,"console[""error""]('[attribution/buyer-safe] Error:', error)","Sanitize error logging",,,
control-plane/adapters/affiliate/amazon.ts,135-158,TypeScript,Type assertion on API response without runtime validation,"const data = await res.json() as { SearchResult?: {...} }","Add type guard or Zod schema for Amazon PAAPI response",,,type-assertion
control-plane/adapters/affiliate/amazon.ts,189-198,Security,AWS Signature V4 implementation incomplete - only includes basic headers,"buildPAAPIHeaders(payload, timestamp)","Verify signature includes payload hash and canonical request (full AWS SigV4 spec)",,,
control-plane/adapters/affiliate/amazon.ts,249,Security,Health check doesn't expose credentials but uses live API call,"await this.searchProducts('test')","Document that health check validates auth + connectivity. Acceptable pattern.",,,verified-secure
