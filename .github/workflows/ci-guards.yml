name: CI Guards
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ci-guards-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run type-check
        run: |
          set -o pipefail
          npm run type-check 2>&1 | tee ci-reports/type-check-output.txt
      - name: Upload type-check failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: type-check-failure-report
          path: ci-reports/
          retention-days: 7

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run audit-ci
        run: |
          set -o pipefail
          npx audit-ci --moderate 2>&1 | tee ci-reports/audit-ci-output.txt
      - name: Upload security-audit failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-audit-failure-report
          path: ci-reports/
          retention-days: 7

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004 # main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before }}
          head: ${{ github.event.pull_request.head.sha || github.sha }}
          extra_args: --debug --only-verified
      - name: Save scan summary on failure
        if: failure()
        run: |
          mkdir -p ci-reports
          echo "TruffleHog secret scan failed at $(date -u)" > ci-reports/trufflehog-summary.txt
          echo "Review the Actions log for full TruffleHog output." >> ci-reports/trufflehog-summary.txt
      - name: Upload secret-scan failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: secret-scan-failure-report
          path: ci-reports/
          retention-days: 7
          if-no-files-found: ignore

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run ESLint (JSON capture)
        run: |
          npx eslint . --ext .ts,.tsx \
            --ignore-pattern 'node_modules/**' \
            --ignore-pattern 'dist/**' \
            --ignore-pattern 'build/**' \
            -f json -o ci-reports/eslint-report.json || true
      - name: Run ESLint
        run: npm run lint
      - name: Run security lint (JSON capture)
        run: |
          npx eslint . --ext .ts,.tsx \
            --config .eslintrc.security.cjs \
            --ignore-pattern 'node_modules/**' \
            --ignore-pattern 'dist/**' \
            --ignore-pattern 'build/**' \
            -f json -o ci-reports/eslint-security-report.json || true
      - name: Run security lint
        run: npm run lint:security
      - name: Upload lint failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: lint-failure-report
          path: ci-reports/
          retention-days: 7

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379
    env:
      CONTROL_PLANE_DB: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Apply migrations
        run: npm run migrate
      - name: Run unit tests
        env:
          JEST_JUNIT_OUTPUT_DIR: ci-reports
          JEST_JUNIT_OUTPUT_NAME: junit-unit.xml
        run: |
          npx jest --config jest.config.ts \
            --testPathPattern=unit \
            --passWithNoTests \
            --ci \
            --reporters=default \
            --reporters=jest-junit
      - name: Run integration tests
        env:
          JEST_JUNIT_OUTPUT_DIR: ci-reports
          JEST_JUNIT_OUTPUT_NAME: junit-integration.xml
        run: |
          npx jest --config jest.config.ts \
            --testPathPattern=integration \
            --runInBand \
            --passWithNoTests \
            --ci \
            --reporters=default \
            --reporters=jest-junit
      - name: Upload test failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-failure-report
          path: |
            ci-reports/
            coverage/
          retention-days: 7
          if-no-files-found: ignore

  openapi-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run OpenAPI lint
        run: |
          set -o pipefail
          npx spectral lint docs/openapi.json --fail-severity warn \
            2>&1 | tee ci-reports/spectral-output.txt
      - name: Upload OpenAPI lint failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: openapi-lint-failure-report
          path: ci-reports/
          retention-days: 7

  test-a11y:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run accessibility tests
        env:
          JEST_JUNIT_OUTPUT_DIR: ci-reports
          JEST_JUNIT_OUTPUT_NAME: junit-a11y.xml
        run: |
          npx jest --config jest.config.ts \
            --selectProjects a11y \
            --passWithNoTests \
            --ci \
            --reporters=default \
            --reporters=jest-junit
      - name: Upload a11y test failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-a11y-failure-report
          path: ci-reports/
          retention-days: 7

  test-extended:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379
    env:
      CONTROL_PLANE_DB: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports
      - name: Run load tests
        run: |
          npx vitest run --config vitest.config.ts test/load \
            --testTimeout=60000 \
            --reporter=default \
            --reporter=junit \
            --outputFile.junit=ci-reports/junit-load.xml
      - name: Run benchmark tests
        run: |
          npx vitest run --config vitest.config.ts test/benchmarks \
            --testTimeout=30000 \
            --reporter=default \
            --reporter=junit \
            --outputFile.junit=ci-reports/junit-bench.xml
      - name: Run chaos tests
        run: |
          npx vitest run --config vitest.config.ts test/chaos \
            --testTimeout=30000 \
            --reporter=default \
            --reporter=junit \
            --outputFile.junit=ci-reports/junit-chaos.xml
      - name: Upload extended test failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-extended-failure-report
          path: ci-reports/
          retention-days: 7

  migration-check:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      CONTROL_PLANE_DB: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports

      - name: Apply all migrations
        run: |
          set -o pipefail
          npm run migrate 2>&1 | tee ci-reports/migration-apply.txt

      - name: Verify no pending migrations
        run: |
          OUTPUT=$(npx tsx scripts/migrate.ts status 2>&1)
          echo "$OUTPUT"
          echo "$OUTPUT" > ci-reports/migration-status.txt
          if echo "$OUTPUT" | grep -q "Pending migrations (0)"; then
            echo "All migrations applied successfully."
          else
            echo "ERROR: Pending migrations detected after running 'up'."
            exit 1
          fi

      - name: Rollback all migrations
        run: |
          set -o pipefail
          npm run migrate:rollback -- --all 2>&1 | tee ci-reports/migration-rollback.txt

      - name: Re-apply all migrations (roundtrip verification)
        run: |
          set -o pipefail
          npm run migrate 2>&1 | tee ci-reports/migration-reapply.txt

      - name: Final migration status
        run: |
          npx tsx scripts/migrate.ts status 2>&1 | tee ci-reports/migration-final-status.txt

      - name: Upload migration failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: migration-check-failure-report
          path: ci-reports/
          retention-days: 7

  test-visual:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      LOG_LEVEL: info
      SERVICE_NAME: smartbeak-web
      CONTROL_PLANE_DB: postgresql://stub:stub@localhost:5432/stub
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_stub
      CLERK_SECRET_KEY: sk_test_stub
      CLERK_WEBHOOK_SECRET: whsec_stub
      STRIPE_SECRET_KEY: sk_test_stub
      STRIPE_WEBHOOK_SECRET: whsec_stub
      JWT_KEY_1: stub_key_1_minimum_32_bytes_long_xxx
      JWT_KEY_2: stub_key_2_minimum_32_bytes_long_xxx
      KEY_ENCRYPTION_SECRET: stub_encryption_key_32_bytes_xxxx
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      NEXT_PUBLIC_ACP_API: http://localhost:3001
      APP_URL: http://localhost:3000
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - run: npm run build:web
      - name: Run visual tests
        run: |
          npx playwright test --config test/visual/playwright.config.ts \
            --reporter=github --reporter=html \
            --update-snapshots
        env:
          PLAYWRIGHT_HTML_REPORT: ci-reports/playwright-report
      - name: Upload visual test failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-visual-failure-report
          path: |
            ci-reports/playwright-report/
            test-results/
          retention-days: 7
          if-no-files-found: ignore

  openapi-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Prepare report directory
        run: mkdir -p ci-reports

      - name: Export OpenAPI spec
        run: |
          npm run openapi:generate
          cp docs/openapi.json openapi-current.json

      - name: Validate OpenAPI spec
        run: |
          set -o pipefail
          npx --yes @redocly/cli lint openapi-current.json \
            --skip-rule no-empty-servers 2>&1 | tee ci-reports/redocly-lint-output.txt

      - name: Check for breaking changes
        if: github.event_name == 'pull_request'
        run: |
          # Get baseline spec from base branch
          git show origin/${{ github.base_ref }}:docs/openapi.json > /tmp/openapi-base.json 2>/dev/null || exit 0

          # Pin oasdiff to a specific version for supply-chain safety
          OASDIFF_VERSION="1.10.25"
          OASDIFF_URL="https://github.com/Tufin/oasdiff/releases/download/v${OASDIFF_VERSION}/oasdiff_${OASDIFF_VERSION}_linux_amd64.tar.gz"
          curl -sSL "$OASDIFF_URL" -o /tmp/oasdiff.tar.gz
          tar xz -f /tmp/oasdiff.tar.gz -C /tmp
          sudo mv /tmp/oasdiff /usr/local/bin/
          rm -f /tmp/oasdiff.tar.gz

          set -o pipefail
          oasdiff breaking /tmp/openapi-base.json openapi-current.json \
            --fail-on ERR 2>&1 | tee ci-reports/oasdiff-breaking-output.txt

      - name: Upload OpenAPI check failure report
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: openapi-check-failure-report
          path: ci-reports/
          retention-days: 7
          if-no-files-found: ignore
