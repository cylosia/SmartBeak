apiVersion: v1
kind: ServiceAccount
metadata:
  name: smartbeak-worker
  labels:
    app.kubernetes.io/name: worker
    app.kubernetes.io/part-of: smartbeak
  annotations:
    eks.amazonaws.com/role-arn: "" # Set via overlay per environment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  labels:
    app.kubernetes.io/name: worker
    app.kubernetes.io/component: worker
    app.kubernetes.io/part-of: smartbeak
spec:
  replicas: 2
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app.kubernetes.io/name: worker
  template:
    metadata:
      labels:
        app.kubernetes.io/name: worker
        app.kubernetes.io/component: worker
        app.kubernetes.io/part-of: smartbeak
    spec:
      serviceAccountName: smartbeak-worker
      terminationGracePeriodSeconds: 60
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      containers:
        - name: worker
          image: smartbeak/worker:IMAGE_TAG_PLACEHOLDER  # CI replaces with git SHA; never deploy :latest
          command: ["node", "--import", "tsx/esm", "apps/api/src/jobs/worker.ts"]
          envFrom:
            - configMapRef:
                name: smartbeak-config
            - secretRef:
                name: smartbeak-secrets
          env:
            - name: SERVICE_NAME
              value: "worker"
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: "1"
              memory: 512Mi
          livenessProbe:
            exec:
              # Worker writes a heartbeat file every job cycle; absence means the process is hung.
              command:
                - sh
                - -c
                - "test $(( $(date +%s) - $(stat -c %Y /tmp/worker-heartbeat 2>/dev/null || echo 0) )) -lt 120"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 2
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
