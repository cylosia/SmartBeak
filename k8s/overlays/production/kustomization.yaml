apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: smartbeak-production
namePrefix: prod-

resources:
  - ../../base

patches:
  - path: patches/api-resources.yaml
  - path: patches/web-resources.yaml
  - path: patches/worker-resources.yaml
  - path: patches/replicas.yaml
  - path: configmap-env.yaml

# FIX: Replace ACCOUNT_ID with the numeric AWS account ID before applying.
# FIX: Replace CI_IMAGE_TAG with an immutable tag or digest (sha256:...) injected
#      by CI at deploy time. Never use 'latest' in production â€” it makes rollbacks
#      impossible and enables supply-chain substitution via mutable tags.
#      CI command: kustomize edit set image smartbeak/api=REPO:$(git rev-parse --short HEAD)
images:
  - name: smartbeak/api
    newName: ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/smartbeak/api
    newTag: CI_IMAGE_TAG
  - name: smartbeak/web
    newName: ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/smartbeak/web
    newTag: CI_IMAGE_TAG
  - name: smartbeak/worker
    newName: ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/smartbeak/worker
    newTag: CI_IMAGE_TAG
